<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录调试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-96">
        <h1 class="text-2xl font-bold mb-6 text-center">登录调试</h1>
        
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                <input type="text" id="username" value="demo" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                <input type="password" id="password" value="demo"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <button type="submit" id="loginBtn" 
                    class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                登录
            </button>
        </form>
        
        <div id="result" class="mt-6"></div>
        
        <div class="mt-6">
            <h2 class="text-lg font-semibold mb-2">测试步骤：</h2>
            <div id="tests" class="space-y-2">
                <button onclick="testHealth()" class="w-full bg-green-500 text-white py-1 px-3 rounded text-sm hover:bg-green-600">
                    1. 测试后端健康检查
                </button>
                <button onclick="testLogin()" class="w-full bg-blue-500 text-white py-1 px-3 rounded text-sm hover:bg-blue-600">
                    2. 测试登录API
                </button>
                <button onclick="testCORS()" class="w-full bg-purple-500 text-white py-1 px-3 rounded text-sm hover:bg-purple-600">
                    3. 测试CORS设置
                </button>
            </div>
        </div>
        
        <div id="logs" class="mt-6 bg-gray-50 p-4 rounded text-xs font-mono max-h-60 overflow-y-auto"></div>
    </div>

    <script>
        const logsContainer = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'info': 'text-blue-600',
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600'
            }[type] || 'text-gray-600';
            
            logsContainer.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        async function testHealth() {
            log('测试后端健康检查...', 'info');
            try {
                const response = await fetch('http://localhost:8002/health');
                const data = await response.json();
                log(`健康检查成功: ${JSON.stringify(data)}`, 'success');
            } catch (error) {
                log(`健康检查失败: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            log('测试CORS设置...', 'info');
            try {
                const response = await fetch('http://localhost:8002/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                log(`CORS测试响应状态: ${response.status}`, response.ok ? 'success' : 'warning');
                log(`CORS Headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');
            } catch (error) {
                log(`CORS测试失败: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            log('测试登录API...', 'info');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                log(`发送登录请求: username=${username}, password=${password}`, 'info');
                
                const response = await fetch('http://localhost:8002/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                log(`响应状态: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`响应头: ${JSON.stringify([...response.headers.entries()])}`, 'info');
                
                const responseText = await response.text();
                log(`原始响应文本: ${responseText}`, 'info');
                
                try {
                    const data = JSON.parse(responseText);
                    log(`解析后的JSON: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    if (data.access_token) {
                        log('登录成功！获取到access_token', 'success');
                        document.getElementById('result').innerHTML = `
                            <div class="bg-green-50 border border-green-200 rounded p-4">
                                <h3 class="text-green-800 font-semibold">登录成功</h3>
                                <p class="text-green-600 text-sm mt-2">用户: ${data.user.name}</p>
                                <p class="text-green-600 text-sm">Token: ${data.access_token.substring(0, 20)}...</p>
                            </div>
                        `;
                    }
                } catch (jsonError) {
                    log(`JSON解析失败: ${jsonError.message}`, 'error');
                    log(`可能是后端返回了HTML而不是JSON`, 'warning');
                }
                
            } catch (error) {
                log(`登录测试失败: ${error.message}`, 'error');
                document.getElementById('result').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded p-4">
                        <h3 class="text-red-800 font-semibold">登录失败</h3>
                        <p class="text-red-600 text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // 表单提交处理
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await testLogin();
        });

        // 页面加载时自动测试健康检查
        window.addEventListener('load', () => {
            log('页面加载完成，开始自动测试...', 'info');
            testHealth();
        });
    </script>
</body>
</html>