# Makefile for Backend Testing
# åç«¯æµ‹è¯•è‡ªåŠ¨åŒ–è„šæœ¬

.PHONY: help install test test-unit test-integration test-performance test-all test-quick test-coverage clean lint format check-security

# é»˜è®¤ç›®æ ‡
help:
	@echo "æ™ºå²³3.0åç«¯æµ‹è¯•è‡ªåŠ¨åŒ–"
	@echo "========================"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  install           å®‰è£…æµ‹è¯•ä¾èµ–"
	@echo "  test-quick        è¿è¡Œå¿«é€Ÿæµ‹è¯• (æ¨è)"
	@echo "  test-unit         è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  test-integration  è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  test-performance  è¿è¡Œæ€§èƒ½æµ‹è¯•"
	@echo "  test-all          è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test-coverage     è¿è¡Œè¦†ç›–ç‡æµ‹è¯•"
	@echo "  lint              ä»£ç æ£€æŸ¥"
	@echo "  format            ä»£ç æ ¼å¼åŒ–"
	@echo "  check-security    å®‰å…¨æ£€æŸ¥"
	@echo "  clean             æ¸…ç†æµ‹è¯•æ–‡ä»¶"

# å®‰è£…æµ‹è¯•ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…æµ‹è¯•ä¾èµ–..."
	pip install -r requirements.txt
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# å¿«é€Ÿæµ‹è¯• (æ¨èç”¨äºå¼€å‘)
test-quick:
	@echo "âš¡ è¿è¡Œå¿«é€Ÿæµ‹è¯•..."
	python test_runner.py quick

# å•å…ƒæµ‹è¯•
test-unit:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	python test_runner.py unit

# é›†æˆæµ‹è¯•
test-integration:
	@echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
	python test_runner.py integration

# æ€§èƒ½æµ‹è¯•
test-performance:
	@echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	python test_runner.py performance

# æ‰€æœ‰æµ‹è¯•
test-all:
	@echo "ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	python test_runner.py all

# è¦†ç›–ç‡æµ‹è¯•
test-coverage:
	@echo "ğŸ“Š è¿è¡Œè¦†ç›–ç‡æµ‹è¯•..."
	python test_runner.py coverage
	@echo "ğŸ“ˆ è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: htmlcov/index.html"

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
test-file:
	@if [ -z "$(FILE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šæµ‹è¯•æ–‡ä»¶: make test-file FILE=path/to/test.py"; \
	else \
		echo "ğŸ¯ è¿è¡Œç‰¹å®šæµ‹è¯•: $(FILE)"; \
		python test_runner.py specific --test-path $(FILE); \
	fi

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	flake8 ../backend --max-line-length=100 --exclude=migrations,__pycache__
	mypy ../backend --ignore-missing-imports
	@echo "âœ… ä»£ç æ£€æŸ¥å®Œæˆ"

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	black ../backend --line-length=100
	isort ../backend --profile black
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# å®‰å…¨æ£€æŸ¥
check-security:
	@echo "ğŸ”’ è¿è¡Œå®‰å…¨æ£€æŸ¥..."
	bandit -r ../backend -f json -o security-report.json || true
	safety check --json --output safety-report.json || true
	@echo "âœ… å®‰å…¨æ£€æŸ¥å®Œæˆï¼ŒæŠ¥å‘Šå·²ç”Ÿæˆ"

# æ¸…ç†æµ‹è¯•æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æµ‹è¯•æ–‡ä»¶..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	rm -rf htmlcov/
	rm -rf .coverage
	rm -f test_zhiyue.db
	rm -f *.log
	rm -f *-report.json
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ
check-env:
	@echo "ğŸ”§ æ£€æŸ¥æµ‹è¯•ç¯å¢ƒ..."
	@python -c "import sys; print(f'Pythonç‰ˆæœ¬: {sys.version}')"
	@python -c "import pytest; print(f'Pytestç‰ˆæœ¬: {pytest.__version__}')"
	@echo "âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆ"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
report:
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
	python test_runner.py all --no-summary > test-report.txt 2>&1 || true
	@echo "âœ… æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: test-report.txt"

# æŒç»­é›†æˆæµ‹è¯•
ci:
	@echo "ğŸ”„ è¿è¡ŒCIæµ‹è¯•..."
	make clean
	make install
	make lint
	make check-security
	make test-coverage
	@echo "âœ… CIæµ‹è¯•å®Œæˆ"

# å¼€å‘ç¯å¢ƒæµ‹è¯•
dev:
	@echo "ğŸ› ï¸  è¿è¡Œå¼€å‘ç¯å¢ƒæµ‹è¯•..."
	make clean
	make test-quick
	@echo "âœ… å¼€å‘ç¯å¢ƒæµ‹è¯•å®Œæˆ"

# å®Œæ•´æµ‹è¯•æµç¨‹
full:
	@echo "ğŸ¯ è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹..."
	make clean
	make check-env
	make install
	make format
	make lint
	make test-all
	make test-coverage
	make check-security
	@echo "ğŸ‰ å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆ"