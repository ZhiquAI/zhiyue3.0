import React, { useState, useMemo, useEffect } from 'react';
import { Card, Row, Col, Breadcrumb, Button, Segmented, Collapse, Input, Tooltip, message, Tabs, Upload, Progress, Alert, Tag, Spin, Modal } from 'antd';
import { CheckCircleOutlined, FileImageOutlined, FileDoneOutlined, EyeOutlined, SwapOutlined, UploadOutlined, FilePdfOutlined, ZoomInOutlined, ZoomOutOutlined, DeleteOutlined, RobotOutlined, SettingOutlined } from '@ant-design/icons';
import { useAppContext } from '../../contexts/AppContext';
import { Exam } from '../../types/exam';
import { mockConfigureData } from '../../data/mockData';
import PDFViewer from '../common/PDFViewer';
import QuestionRecognitionWorkspace from './QuestionRecognitionWorkspace';
import { RecognizedQuestion, AutoGeneratedRubric } from '../../services/questionRecognitionApi';

interface ConfigureWorkspaceProps {
  exam: Exam;
}

interface UploadedFile {
  name: string;
  url: string;
  type: string;
  size: number;
  originalFile: File;
  pages?: string[];
}

const ConfigureWorkspace: React.FC<ConfigureWorkspaceProps> = ({ exam }) => {
  const { setSubViewInfo } = useAppContext();
  const [selectedQuestionId, setSelectedQuestionId] = useState('q13');
  const [activePreviewTab, setActivePreviewTab] = useState('paper');
  const [uploadedFiles, setUploadedFiles] = useState<{
    paper: UploadedFile | null;
    answer: UploadedFile | null;
  }>({
    paper: null,
    answer: null
  });
  const [processingStatus, setProcessingStatus] = useState({
    paper: 'none' as 'none' | 'uploading' | 'processing' | 'completed' | 'error',
    answer: 'none' as 'none' | 'uploading' | 'processing' | 'completed' | 'error'
  });
  const [currentPage, setCurrentPage] = useState({
    paper: 0,
    answer: 0
  });
  const [zoomLevel, setZoomLevel] = useState(100);
  const [showRecognitionWorkspace, setShowRecognitionWorkspace] = useState(false);
  const [recognizedQuestions, setRecognizedQuestions] = useState<RecognizedQuestion[]>([]);
  const [generatedRubrics, setGeneratedRubrics] = useState<AutoGeneratedRubric[]>([]);
  const [configurationMode, setConfigurationMode] = useState<'manual' | 'ai'>('manual');

  const selectedQuestion = useMemo(() => {
    if (recognizedQuestions.length > 0) {
      return recognizedQuestions.find(q => q.id === selectedQuestionId);
    }
    return mockConfigureData.questions.find(q => q.id === selectedQuestionId);
  }, [selectedQuestionId, recognizedQuestions]);

  const selectedRubric = useMemo(() => {
    if (generatedRubrics.length > 0) {
      const rubric = generatedRubrics.find(r => r.questionId === selectedQuestionId);
      if (rubric) {
        return {
          dimensions: rubric.dimensions.map(dim => ({
            id: dim.id,
            name: dim.name,
            points: dim.maxPoints,
            guide: dim.description,
            keywords: dim.keywords
          }))
        };
      }
    }
    return mockConfigureData.rubrics[selectedQuestionId];
  }, [selectedQuestionId, generatedRubrics]);

  const handleBack = () => {
    setSubViewInfo({ view: null, exam: null });
  };

  const handleSaveConfiguration = () => {
    message.success('æ‰€æœ‰é…ç½®å·²ä¿å­˜ï¼');
  };

  // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
  const handleFileUpload = (type: 'paper' | 'answer') => async (info: any) => {
    const { file, fileList } = info;
    
    if (file.status === 'uploading') {
      setProcessingStatus(prev => ({ ...prev, [type]: 'uploading' }));
      return;
    }
    
    if (fileList.length === 0) {
      // æ–‡ä»¶è¢«ç§»é™¤
      setUploadedFiles(prev => ({ ...prev, [type]: null }));
      setProcessingStatus(prev => ({ ...prev, [type]: 'none' }));
      setCurrentPage(prev => ({ ...prev, [type]: 0 }));
      return;
    }

    const uploadedFile = fileList[fileList.length - 1];
    const fileObj = uploadedFile.originFileObj || uploadedFile;
    
    if (fileObj) {
      try {
        setProcessingStatus(prev => ({ ...prev, [type]: 'processing' }));
        
        const newFile: UploadedFile = {
          name: fileObj.name,
          url: URL.createObjectURL(fileObj),
          type: fileObj.type,
          size: fileObj.size,
          originalFile: fileObj
        };
        
        setUploadedFiles(prev => ({ ...prev, [type]: newFile }));
        setProcessingStatus(prev => ({ ...prev, [type]: 'completed' }));
        setCurrentPage(prev => ({ ...prev, [type]: 0 }));
        
        message.success(`${type === 'paper' ? 'è¯•å·' : 'å‚è€ƒç­”æ¡ˆ'}æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼`);
        
      } catch (error) {
        setProcessingStatus(prev => ({ ...prev, [type]: 'error' }));
        message.error(`æ–‡ä»¶å¤„ç†å¤±è´¥: ${error}`);
      }
    }
  };

  // åˆ é™¤æ–‡ä»¶
  const handleDeleteFile = (type: 'paper' | 'answer') => {
    const file = uploadedFiles[type];
    if (file?.url) {
      URL.revokeObjectURL(file.url);
    }
    setUploadedFiles(prev => ({ ...prev, [type]: null }));
    setProcessingStatus(prev => ({ ...prev, [type]: 'none' }));
    setCurrentPage(prev => ({ ...prev, [type]: 0 }));
    message.success(`${type === 'paper' ? 'è¯•å·' : 'å‚è€ƒç­”æ¡ˆ'}æ–‡ä»¶å·²åˆ é™¤`);
  };

  // å¯åŠ¨AIè¯†åˆ«
  const startAIRecognition = () => {
    if (!uploadedFiles.paper) {
      message.warning('è¯·å…ˆä¸Šä¼ è¯•å·æ–‡ä»¶');
      return;
    }
    setConfigurationMode('ai');
    setShowRecognitionWorkspace(true);
  };

  // AIè¯†åˆ«å®Œæˆå›è°ƒ
  const handleRecognitionComplete = (questions: RecognizedQuestion[], rubrics: AutoGeneratedRubric[]) => {
    setRecognizedQuestions(questions);
    setGeneratedRubrics(rubrics);
    setShowRecognitionWorkspace(false);
    
    // é€‰æ‹©ç¬¬ä¸€ä¸ªä¸»è§‚é¢˜
    const firstSubjectiveQuestion = questions.find(q => 
      ['short_answer', 'essay', 'analysis'].includes(q.type)
    );
    if (firstSubjectiveQuestion) {
      setSelectedQuestionId(firstSubjectiveQuestion.id);
    }
    
    message.success('AIè¯†åˆ«å’Œé…ç½®å®Œæˆï¼');
  };

  // æ¸²æŸ“å›¾ç‰‡é¢„è§ˆ
  const renderImagePreview = (file: UploadedFile, type: 'paper' | 'answer') => {
    return (
      <div className="relative h-full bg-gray-100 rounded-lg overflow-hidden">
        {/* æ–‡ä»¶ä¿¡æ¯æ  */}
        <div className="absolute top-0 left-0 right-0 bg-white/95 backdrop-blur-sm p-3 border-b border-gray-200 z-20">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Tag color={type === 'paper' ? 'blue' : 'green'}>
                {type === 'paper' ? 'è¯•å·åŸä»¶' : 'å‚è€ƒç­”æ¡ˆ'}
              </Tag>
              <span className="text-sm font-medium text-gray-700">{file.name}</span>
              <span className="text-xs text-gray-500">
                {(file.size / 1024 / 1024).toFixed(2)} MB
              </span>
            </div>
            <div className="flex items-center gap-2">
              <div className="flex items-center gap-1">
                <Button 
                  type="text" 
                  size="small" 
                  icon={<ZoomOutOutlined />}
                  disabled={zoomLevel <= 50}
                  onClick={() => setZoomLevel(prev => Math.max(50, prev - 25))}
                />
                <span className="text-xs px-1">{zoomLevel}%</span>
                <Button 
                  type="text" 
                  size="small" 
                  icon={<ZoomInOutlined />}
                  disabled={zoomLevel >= 200}
                  onClick={() => setZoomLevel(prev => Math.min(200, prev + 25))}
                />
              </div>
              <Button 
                type="text" 
                size="small" 
                icon={<EyeOutlined />}
                onClick={() => window.open(file.url, '_blank')}
              >
                å…¨å±æŸ¥çœ‹
              </Button>
              <Button 
                type="text" 
                size="small" 
                icon={<DeleteOutlined />}
                onClick={() => handleDeleteFile(type)}
                danger
              >
                åˆ é™¤
              </Button>
            </div>
          </div>
        </div>

        {/* å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */}
        <div className="pt-16 h-full overflow-auto">
          <div className="flex justify-center p-4">
            <div 
              className="relative bg-white shadow-lg rounded-lg overflow-hidden"
              style={{ 
                transform: `scale(${zoomLevel / 100})`,
                transformOrigin: 'top center',
                transition: 'transform 0.3s ease'
              }}
            >
              <img
                src={file.url}
                alt={`${type === 'paper' ? 'è¯•å·' : 'å‚è€ƒç­”æ¡ˆ'}`}
                className="max-w-full h-auto"
                style={{ maxHeight: '800px' }}
              />
              
              {/* é¢˜ç›®æ ‡æ³¨åŒºåŸŸï¼ˆä»…è¯•å·æ˜¾ç¤ºï¼Œä¸”ä»…åœ¨AIæ¨¡å¼ä¸‹ï¼‰ */}
              {type === 'paper' && configurationMode === 'ai' && recognizedQuestions.length > 0 && (
                <div className="absolute inset-0">
                  {recognizedQuestions.map(q => (
                    <Tooltip key={q.id} title={`${q.number}. ${q.content.substring(0, 50)}...`}>
                      <div
                        className={`absolute border-2 transition-all duration-300 cursor-pointer ${
                          selectedQuestionId === q.id
                            ? 'border-blue-500 bg-blue-500/30 ring-4 ring-blue-300'
                            : 'border-dashed border-gray-400 hover:border-blue-300 hover:bg-blue-100/20'
                        }`}
                        style={{
                          left: `${q.region.x}%`,
                          top: `${q.region.y}%`,
                          width: `${q.region.width}%`,
                          height: `${q.region.height}%`
                        }}
                        onClick={() => setSelectedQuestionId(q.id)}
                      >
                        <div className="absolute -top-6 left-0 bg-blue-600 text-white text-xs px-2 py-1 rounded">
                          ç¬¬{q.number}é¢˜
                        </div>
                      </div>
                    </Tooltip>
                  ))}
                </div>
              )}

              {/* æ‰‹åŠ¨æ¨¡å¼çš„æ¨¡æ‹Ÿæ ‡æ³¨ */}
              {type === 'paper' && configurationMode === 'manual' && (
                <div className="absolute inset-0">
                  {mockConfigureData.questions.map(q => (
                    <Tooltip key={q.id} title={q.title}>
                      <div
                        className={`absolute border-2 transition-all duration-300 cursor-pointer ${
                          selectedQuestionId === q.id
                            ? 'border-blue-500 bg-blue-500/30 ring-4 ring-blue-300'
                            : 'border-dashed border-gray-400 hover:border-blue-300 hover:bg-blue-100/20'
                        }`}
                        style={{ ...q.area }}
                        onClick={() => setSelectedQuestionId(q.id)}
                      >
                        <div className="absolute -top-6 left-0 bg-blue-600 text-white text-xs px-2 py-1 rounded">
                          {q.title}
                        </div>
                      </div>
                    </Tooltip>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderFilePreview = (fileType: 'paper' | 'answer') => {
    const file = uploadedFiles[fileType];
    const status = processingStatus[fileType];
    
    if (status === 'none' || !file) {
      return (
        <div className="h-full flex flex-col items-center justify-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
          <Upload
            name="file"
            showUploadList={false}
            beforeUpload={() => false}
            onChange={handleFileUpload(fileType)}
            accept=".pdf,.jpg,.jpeg,.png"
          >
            <div className="text-center p-8">
              <div className="mb-4">
                {fileType === 'paper' ? (
                  <FileImageOutlined style={{ fontSize: '48px', color: '#d9d9d9' }} />
                ) : (
                  <FileDoneOutlined style={{ fontSize: '48px', color: '#d9d9d9' }} />
                )}
              </div>
              <p className="text-gray-500 mb-2">
                {fileType === 'paper' ? 'ç‚¹å‡»ä¸Šä¼ è¯•å·æ–‡ä»¶' : 'ç‚¹å‡»ä¸Šä¼ å‚è€ƒç­”æ¡ˆ'}
              </p>
              <p className="text-xs text-gray-400 mb-3">
                æ”¯æŒ PDFã€JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 10MB
              </p>
              <Button type="primary" ghost icon={<UploadOutlined />}>
                é€‰æ‹©æ–‡ä»¶
              </Button>
            </div>
          </Upload>
        </div>
      );
    }

    if (status === 'uploading') {
      return (
        <div className="h-full flex flex-col items-center justify-center bg-blue-50 rounded-lg">
          <Progress 
            type="circle" 
            percent={30}
            status="active"
            className="mb-4"
          />
          <p className="text-blue-600 font-medium">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</p>
          <p className="text-sm text-gray-500">{file.name}</p>
        </div>
      );
    }

    if (status === 'processing') {
      return (
        <div className="h-full flex flex-col items-center justify-center bg-purple-50 rounded-lg">
          <Spin size="large" className="mb-4" />
          <p className="text-purple-600 font-medium">
            {file.type === 'application/pdf' ? 'AIæ­£åœ¨å¤„ç†PDFæ–‡æ¡£...' : 'æ­£åœ¨å¤„ç†å›¾ç‰‡...'}
          </p>
          <p className="text-sm text-gray-500">{file.name}</p>
          <div className="mt-4 text-xs text-gray-400 text-center">
            <p>â€¢ è¯†åˆ«æ–‡æ¡£ç»“æ„</p>
            <p>â€¢ æå–é¢˜ç›®ä¿¡æ¯</p>
            <p>â€¢ ç”Ÿæˆé¢„è§ˆå›¾ç‰‡</p>
          </div>
        </div>
      );
    }

    if (status === 'error') {
      return (
        <div className="h-full flex flex-col items-center justify-center bg-red-50 rounded-lg">
          <Alert
            message="æ–‡ä»¶å¤„ç†å¤±è´¥"
            description="è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œæˆ–é‡æ–°ä¸Šä¼ æ–‡ä»¶"
            type="error"
            showIcon
            className="mb-4"
          />
          <Button 
            type="primary" 
            danger 
            onClick={() => handleDeleteFile(fileType)}
          >
            é‡æ–°ä¸Šä¼ 
          </Button>
        </div>
      );
    }

    if (status === 'completed' && file) {
      // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©æ¸²æŸ“æ–¹å¼
      if (file.type === 'application/pdf') {
        return (
          <PDFViewer
            file={file.originalFile}
            onDelete={() => handleDeleteFile(fileType)}
            showControls={true}
            className="h-full"
          />
        );
      } else {
        // å›¾ç‰‡æ–‡ä»¶ä½¿ç”¨åŸæœ‰çš„é¢„è§ˆæ–¹å¼
        return renderImagePreview(file, fileType);
      }
    }

    return (
      <div className="h-full flex items-center justify-center bg-gray-50 rounded-lg">
        <Spin size="large" />
      </div>
    );
  };

  const previewTabs = [
    {
      key: 'paper',
      label: (
        <div className="flex items-center gap-2">
          <FileImageOutlined />
          <span>è¯•å·åŸä»¶</span>
          {uploadedFiles.paper && (
            <Tag color="blue" size="small">
              {processingStatus.paper === 'completed' ? 'å·²å¤„ç†' : 'å¤„ç†ä¸­'}
            </Tag>
          )}
        </div>
      ),
      children: renderFilePreview('paper')
    },
    {
      key: 'answer',
      label: (
        <div className="flex items-center gap-2">
          <FileDoneOutlined />
          <span>å‚è€ƒç­”æ¡ˆ</span>
          {uploadedFiles.answer && (
            <Tag color="green" size="small">
              {processingStatus.answer === 'completed' ? 'å·²å¤„ç†' : 'å¤„ç†ä¸­'}
            </Tag>
          )}
        </div>
      ),
      children: renderFilePreview('answer')
    },
    {
      key: 'compare',
      label: (
        <div className="flex items-center gap-2">
          <SwapOutlined />
          <span>å¯¹æ¯”è§†å›¾</span>
          {processingStatus.paper === 'completed' && processingStatus.answer === 'completed' && (
            <Tag color="purple" size="small">å¯ç”¨</Tag>
          )}
        </div>
      ),
      children: (
        <div className="h-full">
          {processingStatus.paper === 'completed' && processingStatus.answer === 'completed' && 
           uploadedFiles.paper && uploadedFiles.answer ? (
            <div className="grid grid-cols-2 gap-4 h-full p-4">
              <div className="relative bg-white rounded-lg shadow-md overflow-hidden">
                <div className="absolute top-2 left-2 z-10">
                  <Tag color="blue">è¯•å·åŸä»¶</Tag>
                </div>
                {uploadedFiles.paper.type === 'application/pdf' ? (
                  <PDFViewer
                    file={uploadedFiles.paper.originalFile}
                    showControls={false}
                    className="h-full"
                  />
                ) : (
                  <img
                    src={uploadedFiles.paper.url}
                    alt="è¯•å·é¢„è§ˆ"
                    className="w-full h-full object-contain"
                  />
                )}
              </div>
              <div className="relative bg-white rounded-lg shadow-md overflow-hidden">
                <div className="absolute top-2 left-2 z-10">
                  <Tag color="green">å‚è€ƒç­”æ¡ˆ</Tag>
                </div>
                {uploadedFiles.answer.type === 'application/pdf' ? (
                  <PDFViewer
                    file={uploadedFiles.answer.originalFile}
                    showControls={false}
                    className="h-full"
                  />
                ) : (
                  <img
                    src={uploadedFiles.answer.url}
                    alt="å‚è€ƒç­”æ¡ˆé¢„è§ˆ"
                    className="w-full h-full object-contain"
                  />
                )}
              </div>
            </div>
          ) : (
            <div className="h-full flex items-center justify-center bg-gray-50 rounded-lg">
              <div className="text-center">
                <SwapOutlined style={{ fontSize: '48px', color: '#d9d9d9' }} className="mb-4" />
                <p className="text-gray-500 mb-2">å¯¹æ¯”è§†å›¾éœ€è¦åŒæ—¶ä¸Šä¼ å¹¶å¤„ç†å®Œæˆè¯•å·å’Œå‚è€ƒç­”æ¡ˆ</p>
                <div className="text-sm text-gray-400 space-y-1">
                  <p>è¯•å·çŠ¶æ€: {
                    processingStatus.paper === 'none' ? 'æœªä¸Šä¼ ' :
                    processingStatus.paper === 'completed' ? 'âœ“ å·²å®Œæˆ' : 'å¤„ç†ä¸­...'
                  }</p>
                  <p>ç­”æ¡ˆçŠ¶æ€: {
                    processingStatus.answer === 'none' ? 'æœªä¸Šä¼ ' :
                    processingStatus.answer === 'completed' ? 'âœ“ å·²å®Œæˆ' : 'å¤„ç†ä¸­...'
                  }</p>
                </div>
              </div>
            </div>
          )}
        </div>
      ),
      disabled: processingStatus.paper !== 'completed' || processingStatus.answer !== 'completed'
    }
  ];

  // æ¸…ç†URLå¯¹è±¡
  useEffect(() => {
    return () => {
      Object.values(uploadedFiles).forEach(file => {
        if (file?.url) {
          URL.revokeObjectURL(file.url);
        }
      });
    };
  }, []);

  // å¦‚æœæ˜¾ç¤ºAIè¯†åˆ«å·¥ä½œå°
  if (showRecognitionWorkspace && uploadedFiles.paper) {
    return (
      <div className="h-full">
        <Breadcrumb className="mb-4" items={[
          { title: <a onClick={handleBack}>è€ƒè¯•ç®¡ç†</a> },
          { title: exam.name },
          { title: 'AIæ™ºèƒ½è¯†åˆ«é…ç½®' }
        ]} />
        
        <QuestionRecognitionWorkspace
          file={uploadedFiles.paper.originalFile}
          onComplete={handleRecognitionComplete}
          onCancel={() => setShowRecognitionWorkspace(false)}
        />
      </div>
    );
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <Breadcrumb
          items={[
            { title: <a onClick={handleBack}>è€ƒè¯•ç®¡ç†</a> },
            { title: exam.name },
            { title: 'é…ç½®è¯•å·' }
          ]}
        />
        <div className="flex items-center gap-2">
          {processingStatus.paper === 'completed' && (
            <Button
              type="primary"
              ghost
              icon={<RobotOutlined />}
              onClick={startAIRecognition}
              className="mr-2"
            >
              AIæ™ºèƒ½è¯†åˆ«
            </Button>
          )}
          <Button
            type="primary"
            size="large"
            icon={<CheckCircleOutlined />}
            onClick={handleSaveConfiguration}
            disabled={processingStatus.paper !== 'completed'}
          >
            å®Œæˆå¹¶ä¿å­˜æ‰€æœ‰é…ç½®
          </Button>
        </div>
      </div>

      {/* é…ç½®æ¨¡å¼æŒ‡ç¤º */}
      {configurationMode === 'ai' && recognizedQuestions.length > 0 && (
        <Alert
          message="AIæ™ºèƒ½é…ç½®æ¨¡å¼"
          description={`å·²è¯†åˆ« ${recognizedQuestions.length} é“é¢˜ç›®ï¼Œå¹¶ç”Ÿæˆå¤šç»´è¯„åˆ†æ ‡å‡†ã€‚æ‚¨å¯ä»¥åœ¨å³ä¾§é¢æ¿ä¸­æŸ¥çœ‹å’Œè°ƒæ•´é…ç½®ã€‚`}
          type="success"
          showIcon
          icon={<RobotOutlined />}
          className="mb-4"
        />
      )}

      {/* æ–‡ä»¶çŠ¶æ€æç¤º */}
      {(processingStatus.paper === 'none' || processingStatus.answer === 'none') && (
        <Alert
          message="æ–‡ä»¶ä¸Šä¼ æé†’"
          description={
            <div>
              {processingStatus.paper === 'none' && <p>â€¢ è¯•å·æ–‡ä»¶æ˜¯å¿…éœ€çš„ï¼Œè¯·å…ˆä¸Šä¼ è¯•å·åŸä»¶ï¼ˆæ”¯æŒPDFã€JPGã€PNGæ ¼å¼ï¼‰</p>}
              {processingStatus.answer === 'none' && <p>â€¢ å‚è€ƒç­”æ¡ˆæ˜¯å¯é€‰çš„ï¼Œä¸Šä¼ åå¯ä»¥è‡ªåŠ¨ç”Ÿæˆè¯„åˆ†æ ‡å‡†</p>}
              <p>â€¢ ä¸Šä¼ è¯•å·åï¼Œå¯ä»¥ä½¿ç”¨AIæ™ºèƒ½è¯†åˆ«åŠŸèƒ½è‡ªåŠ¨é…ç½®é¢˜ç›®å’Œè¯„åˆ†æ ‡å‡†</p>
              <p>â€¢ ä¸Šä¼ çš„PDFæ–‡ä»¶å°†è‡ªåŠ¨è§£æå¹¶æ˜¾ç¤ºï¼Œæ”¯æŒåˆ†é¡µæµè§ˆå’Œç¼©æ”¾æ“ä½œ</p>
            </div>
          }
          type="info"
          showIcon
          className="mb-4"
        />
      )}

      <Row gutter={[24, 24]}>
        <Col xs={24} lg={12} className="flex flex-col">
          <Card title="æ–‡æ¡£é¢„è§ˆ" className="flex-grow">
            <Tabs
              activeKey={activePreviewTab}
              onChange={setActivePreviewTab}
              items={previewTabs}
              className="h-full"
              tabBarStyle={{ marginBottom: 16 }}
            />
          </Card>
        </Col>

        <Col xs={24} lg={12} className="flex flex-col">
          <Card 
            title={
              <div className="flex items-center justify-between">
                <span>ä¸»è§‚é¢˜é…ç½®å·¥ä½œå°</span>
                {configurationMode === 'ai' && (
                  <Tag color="purple" icon={<RobotOutlined />}>AIæ¨¡å¼</Tag>
                )}
              </div>
            } 
            className="flex-grow"
          >
            {processingStatus.paper === 'completed' ? (
              <>
                <Segmented
                  block
                  options={
                    configurationMode === 'ai' && recognizedQuestions.length > 0
                      ? recognizedQuestions
                          .filter(q => ['short_answer', 'essay', 'analysis'].includes(q.type))
                          .map(q => ({
                            label: `ç¬¬${q.number}é¢˜`,
                            value: q.id,
                            title: q.content.substring(0, 50) + '...'
                          }))
                      : mockConfigureData.questions.map(q => ({
                          label: `ç¬¬${q.id.slice(1)}é¢˜`,
                          value: q.id,
                          title: q.title
                        }))
                  }
                  value={selectedQuestionId}
                  onChange={setSelectedQuestionId}
                  className="mb-4"
                />

                <div className="flex flex-col gap-4 mt-4">
                  <Card type="inner" title="å®˜æ–¹å‚è€ƒç­”æ¡ˆ" size="small">
                    <p className="text-gray-600 text-sm">
                      {selectedQuestion?.content || selectedQuestion?.answer}
                    </p>
                  </Card>

                  <Card 
                    type="inner" 
                    title={
                      <div className="flex items-center justify-between">
                        <span>å¤šç»´è¯„åˆ†æ ‡å‡†ç¼–è¾‘å™¨</span>
                        {configurationMode === 'ai' && (
                          <Tag color="green" size="small">AIç”Ÿæˆ</Tag>
                        )}
                      </div>
                    } 
                    className="flex-grow"
                  >
                    <Collapse
                      defaultActiveKey={selectedRubric?.dimensions.map(d => d.id)}
                    >
                      {selectedRubric?.dimensions.map(dim => (
                        <Collapse.Panel
                          key={dim.id}
                          header={
                            <div className="flex justify-between items-center w-full">
                              <span className="font-semibold">{dim.name}</span>
                              <Input
                                defaultValue={dim.points}
                                onClick={e => e.stopPropagation()}
                                className="w-20 text-center"
                                type="number"
                                addonAfter="åˆ†"
                              />
                            </div>
                          }
                        >
                          <div className="space-y-3">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium w-20">è¯„åˆ†æŒ‡å¼•</span>
                              <Input.TextArea
                                rows={2}
                                defaultValue={dim.guide}
                              />
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium w-20">å…³é”®è¯</span>
                              <Input
                                defaultValue={(dim.keywords || []).join('ï¼Œ')}
                              />
                            </div>
                          </div>
                        </Collapse.Panel>
                      ))}
                    </Collapse>
                  </Card>
                </div>
              </>
            ) : (
              <div className="h-full flex items-center justify-center">
                <div className="text-center">
                  <FileImageOutlined style={{ fontSize: '48px', color: '#d9d9d9' }} className="mb-4" />
                  <p className="text-gray-500 mb-2">è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†è¯•å·æ–‡ä»¶</p>
                  <p className="text-sm text-gray-400">
                    {processingStatus.paper === 'none' && 'ä¸Šä¼ PDFæˆ–å›¾ç‰‡æ ¼å¼çš„è¯•å·æ–‡ä»¶'}
                    {processingStatus.paper === 'uploading' && 'æ–‡ä»¶ä¸Šä¼ ä¸­...'}
                    {processingStatus.paper === 'processing' && 'AIæ­£åœ¨åˆ†æè¯•å·å†…å®¹...'}
                    {processingStatus.paper === 'error' && 'æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ '}
                  </p>
                  {processingStatus.paper === 'none' && (
                    <div className="mt-4">
                      <p className="text-xs text-blue-600 mb-2">ğŸ’¡ æ¨èä½¿ç”¨AIæ™ºèƒ½è¯†åˆ«</p>
                      <p className="text-xs text-gray-400">ä¸Šä¼ è¯•å·åï¼ŒAIå°†è‡ªåŠ¨è¯†åˆ«é¢˜ç›®å¹¶ç”Ÿæˆè¯„åˆ†æ ‡å‡†</p>
                    </div>
                  )}
                </div>
              </div>
            )}
          </Card>
        </Col>
      </Row>
    </div>
  );
};

export default ConfigureWorkspace;