\<!DOCTYPE html\>
<html lang="zh-CN">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>
条形码批量生成和打印工具
</title>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
font-family: 'Inter', 'Noto Sans SC', 'Helvetica Neue', 'Arial', sans-serif;
}
.main-container {
background: white;
padding: 2rem;
border-radius: 0.5rem;
box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
}
/\* 单个条形码样式 */
.barcode-item {
display: inline-block;
vertical-align: top;
padding: 10px;
margin: 5px;
border: 1px solid \#eee;
border-radius: 4px;
page-break-inside: avoid; /* 打印时防止元素被截断 */
font-family: 'Noto Sans SC', sans-serif;
width: calc(33.333% - 10px); /* 每行3个 \*/
box-sizing: border-box;
}
.barcode-item .top-text {
display: flex;
justify-content: space-between;
font-size: 10px;
font-weight: 600;
margin-bottom: 4px;
}
.barcode-item .bottom-text {
text-align: center;
font-size: 10px;
font-weight: 600;
margin-top: 4px;
word-break: break-all;
}
.barcode-item svg {
width: 100%;
}

    /* 打印样式 */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .barcode-item {
                 border: 1px solid #ccc;
            }
        }
    </style>

</head>

<body class="bg-gray-100 p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="main-container">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">批量条形码生成和打印工具</h1>
            <p class="text-center text-gray-500 mb-6">上传CSV文件，一键生成所有学生的条形码并打印。</p>
    
            <!-- 步骤说明 -->
            <div class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-md mb-6" role="alert">
              <p class="font-bold">使用说明</p>
              <ol class="list-decimal list-inside mt-2 text-sm">
                <li>准备一个CSV文件。第一行必须是表头，且必须包含以下列：`studentId`, `name`, `className`, `seatNumber`, `examRoom`。</li>
                <li>点击“选择文件”按钮，上传您的CSV文件。</li>
                <li>点击“生成条形码”按钮，下方会预览所有生成的条形码。</li>
                <li>确认无误后，点击“打印”按钮，即可打印全部条形码。</li>
              </ol>
               <p class="mt-2 text-sm"><b>提示:</b> CSV文件可以用Excel或WPS表格另存为获得。 <a href="data:text/csv;charset=utf-8,studentId,name,className,seatNumber,examRoom%0A99284196,任一彤,九年07班,4643,18%0A99284197,李华,九年08班,4644,18" download="template.csv" class="font-semibold underline">下载CSV模板文件</a></p>
            </div>
    
            <!-- 操作区域 -->
            <div class="flex items-center space-x-4">
                <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                <button id="generate-btn" class="px-6 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 whitespace-nowrap">生成条形码</button>
                <button id="print-btn" class="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 whitespace-nowrap hidden">打印</button>
            </div>
            <p id="status-message" class="text-center text-gray-600 mt-4 h-5"></p>
        </div>
    
        <!-- 打印预览区域 -->
        <div id="print-area" class="mt-8 bg-white p-4 rounded-md shadow-lg">
            <!-- 生成的条形码将插入这里 -->
        </div>
    </div>
    
    <script>
        const fileInput = document.getElementById('csv-file');
        const generateBtn = document.getElementById('generate-btn');
        const printBtn = document.getElementById('print-btn');
        const printArea = document.getElementById('print-area');
        const statusMessage = document.getElementById('status-message');
    
        generateBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                statusMessage.textContent = '请先选择一个CSV文件。';
                return;
            }
    
            const reader = new FileReader();
            reader.onload = function(event) {
                const csvText = event.target.result;
                try {
                    const studentData = parseCSV(csvText);
                    generateBarcodes(studentData);
                } catch (error) {
                    statusMessage.textContent = `处理文件失败: ${error.message}`;
                    console.error(error);
                }
            };
            reader.onerror = function() {
                statusMessage.textContent = '读取文件时发生错误。';
            };
            reader.readAsText(file, 'UTF-8');
        });
        
        printBtn.addEventListener('click', () => {
            window.print();
        });
    
        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) {
                throw new Error("CSV文件至少需要包含表头和一行数据。");
            }
            const headers = lines[0].split(',').map(h => h.trim());
            const requiredHeaders = ['studentId', 'name', 'className', 'seatNumber', 'examRoom'];
            
            // 检查必需的表头是否存在
            for(const required of requiredHeaders) {
                if(!headers.includes(required)) {
                    throw new Error(`CSV文件缺少必需的表头: ${required}`);
                }
            }
    
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i]) continue;
                const values = lines[i].split(',');
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header] = values[index] ? values[index].trim() : '';
                });
                data.push(entry);
            }
            return data;
        }
    
        function generateBarcodes(data) {
            printArea.innerHTML = ''; // 清空旧内容
            statusMessage.textContent = `正在生成 ${data.length} 个条形码...`;
    
            data.forEach(student => {
                const item = document.createElement('div');
                item.className = 'barcode-item';
    
                const studentId = student.studentId || 'N/A';
    
                item.innerHTML = `
                    <div class="top-text">
                        <span>座号:${student.seatNumber || ''}</span>
                        <span>考场:${student.examRoom || ''}</span>
                    </div>
                    <svg class="barcode-svg" id="barcode-${studentId}"></svg>
                    <div class="bottom-text">
                        <span>班级:${student.className || ''}${studentId}姓名:${student.name || ''}</span>
                    </div>
                `;
                printArea.appendChild(item);
    
                // 生成条形码
                try {
                    JsBarcode(`#barcode-${studentId}`, studentId, {
                        format: "CODE128",
                        lineColor: "#000",
                        width: 2,
                        height: 40,
                        displayValue: false,
                        margin: 0
                    });
                } catch(e) {
                    console.warn(`无法为学号 "${studentId}" 生成条形码: ${e.message}`);
                    const errorPlaceholder = item.querySelector(`#barcode-${studentId}`);
                    errorPlaceholder.outerHTML = `<div class="text-red-500 text-xs text-center p-2">条码生成失败</div>`;
                }
            });
            
            statusMessage.textContent = `成功生成 ${data.length} 个条形码！现在可以打印了。`;
            printBtn.classList.remove('hidden');
        }
    </script>

</body>

</html>
