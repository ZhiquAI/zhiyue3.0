\<!DOCTYPE html\>
<html lang="zh-CN">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>

答题卡模板设计器 - 原型
</title>

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        #canvas-wrapper {
            cursor: grab;
        }
        #canvas-wrapper.panning {
            cursor: grabbing;
        }
        #canvas {
            position: relative;
            width: 800px;
            height: 1120px; /* A4 paper aspect ratio */
            background-image: url('https://placehold.co/800x1120/FFFFFF/E0E0E0?text=在此上传答题卡底图');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            cursor: crosshair;
            overflow: hidden;
            transform-origin: top left;
            transition: transform 0.2s ease;
        }
        .region {
            position: absolute;
            border-width: 2px;
            box-sizing: border-box;
            opacity: 0.7;
            cursor: move;
        }
        .region.selected {
            opacity: 1;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
            z-index: 10;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #4f46e5;
            border: 1px solid white;
            border-radius: 50%;
            z-index: 11;
        }
        .resize-handle.nw { top: -5px; left: -5px; cursor: nwse-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: nesw-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: nesw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: nwse-resize; }
        
        .tool-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .history-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .omr-grid-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            line-height: 1;
            white-space: nowrap;
        }
    </style>

</head>

<body class="w-full min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md z-20">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800 flex items-center">
                <i data-lucide="layout-template" class="w-6 h-6 mr-3 text-indigo-600"></i>答题卡模板设计器
            </h1>
            <div class="flex items-center space-x-2">
                 <button id="load-template-btn" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300 flex items-center">
                    <i data-lucide="folder-open" class="w-4 h-4 mr-2"></i>加载模板
                 </button>
                 <input type="file" id="load-template-input" class="hidden" accept=".json,text/plain">
                 <button id="save-template-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-md hover:bg-indigo-700 flex items-center">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>保存模板
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Toolbar -->
        <aside class="w-56 bg-white p-4 space-y-4 border-r border-gray-200 flex flex-col">
            <div>
                <button id="upload-bg-btn" class="w-full flex items-center justify-center px-4 py-2 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 transition">
                    <i data-lucide="image-plus" class="w-5 h-5 mr-2"></i>上传底图
                </button>
                <input type="file" id="bg-upload-input" class="hidden" accept="image/*">
            </div>
            <div class="pt-4 border-t">
                <h2 class="text-lg font-semibold text-gray-700">工具箱</h2>
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button class="tool-btn flex flex-col items-center justify-center p-3 border rounded-lg hover:bg-gray-100 transition" data-tool="timing">
                        <i data-lucide="scan-search" class="w-8 h-8 text-gray-600"></i><span class="text-xs mt-1">定位点</span>
                    </button>
                    <button class="tool-btn flex flex-col items-center justify-center p-3 border rounded-lg hover:bg-gray-100 transition" data-tool="barcode">
                        <i data-lucide="qr-code" class="w-8 h-8 text-gray-600"></i><span class="text-xs mt-1">条码区</span>
                    </button>
                    <button class="tool-btn flex flex-col items-center justify-center p-3 border rounded-lg hover:bg-gray-100 transition" data-tool="omr">
                        <i data-lucide="check-square" class="w-8 h-8 text-gray-600"></i><span class="text-xs mt-1">客观题</span>
                    </button>
                    <button class="tool-btn flex flex-col items-center justify-center p-3 border rounded-lg hover:bg-gray-100 transition" data-tool="subjective">
                        <i data-lucide="edit" class="w-8 h-8 text-gray-600"></i><span class="text-xs mt-1">主观题</span>
                    </button>
                </div>
            </div>
            <div class="pt-4 border-t flex-1 flex flex-col min-h-0">
                 <h2 class="text-lg font-semibold text-gray-700">图层列表</h2>
                 <div id="layers-list" class="mt-2 space-y-1 flex-1 overflow-y-auto">
                     <p class="text-sm text-gray-400 text-center py-4">尚未创建任何区域</p>
                 </div>
            </div>
            <div class="pt-4 border-t">
                <h2 class="text-lg font-semibold text-gray-700">历史记录</h2>
                <div class="flex items-center justify-center space-x-4 mt-2">
                    <button id="undo-btn" class="history-btn p-2 border rounded-md hover:bg-gray-100 disabled:bg-gray-50"><i data-lucide="undo-2" class="w-5 h-5"></i></button>
                    <button id="redo-btn" class="history-btn p-2 border rounded-md hover:bg-gray-100 disabled:bg-gray-50"><i data-lucide="redo-2" class="w-5 h-5"></i></button>
                </div>
            </div>
        </aside>

        <!-- Center Canvas -->
        <main id="canvas-wrapper" class="flex-1 flex items-center justify-center p-8 bg-gray-100 overflow-auto">
            <div id="canvas">
                <!-- Drawn regions will be appended here -->
            </div>
        </main>

        <!-- Right Properties Panel -->
        <aside class="w-72 bg-white p-4 border-l border-gray-200 overflow-y-auto">
            <h2 class="text-lg font-semibold text-gray-700">属性配置</h2>
            <div id="properties-panel" class="mt-4 space-y-4">
                <div class="text-center text-gray-400 py-10">
                    <i data-lucide="mouse-pointer-square" class="w-12 h-12 mx-auto"></i>
                    <p class="mt-2 text-sm">请先选择一个区域</p>
                </div>
            </div>
             <div class="pt-4 mt-4 border-t">
                <h2 class="text-lg font-semibold text-gray-700">画布操作</h2>
                <div class="flex items-center space-x-2 mt-2">
                    <button id="zoom-in-btn" class="p-2 border rounded-md hover:bg-gray-100"><i data-lucide="zoom-in" class="w-5 h-5"></i></button>
                    <button id="zoom-out-btn" class="p-2 border rounded-md hover:bg-gray-100"><i data-lucide="zoom-out" class="w-5 h-5"></i></button>
                    <button id="reset-zoom-btn" class="p-2 border rounded-md hover:bg-gray-100"><i data-lucide="expand" class="w-5 h-5"></i></button>
                    <span id="zoom-level" class="text-sm text-gray-600">100%</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">提示：按住 <kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-md">空格键</kbd> 可拖动画布。</p>
            </div>
        </aside>
    </div>

    <script>
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const canvas = document.getElementById('canvas');
        const propertiesPanel = document.getElementById('properties-panel');
        const layersList = document.getElementById('layers-list');
        
        // UI elements
        const saveBtn = document.getElementById('save-template-btn');
        const loadTemplateBtn = document.getElementById('load-template-btn');
        const loadTemplateInput = document.getElementById('load-template-input');
        const uploadBgBtn = document.getElementById('upload-bg-btn');
        const bgUploadInput = document.getElementById('bg-upload-input');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const resetZoomBtn = document.getElementById('reset-zoom-btn');
        const zoomLevelSpan = document.getElementById('zoom-level');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');

        // State variables
        let regions = [];
        let selectedRegionId = null;
        let currentTool = null;
        let regionCounter = 0;
        let scale = 1;

        // History (Undo/Redo) state
        let history = [[]];
        let historyIndex = 0;

        // Action states
        let actionState = {
            isDrawing: false,
            isMoving: false,
            isResizing: false,
            isPanning: false,
            startX: 0,
            startY: 0,
            lastPanX: 0,
            lastPanY: 0,
            currentRegionEl: null,
            resizeHandle: null
        };

        const toolConfig = {
            timing: { name: '定位点', color: 'border-red-500', bgColor: 'bg-red-500' },
            barcode: { name: '条码区', color: 'border-purple-500', bgColor: 'bg-purple-500' },
            omr: { name: '客观题', color: 'border-blue-500', bgColor: 'bg-blue-500' },
            subjective: { name: '主观题', color: 'border-green-500', bgColor: 'bg-green-500' }
        };

        // --- Core Functions ---

        function renderAll() {
            canvas.innerHTML = '';
            regions.forEach(regionData => {
                const regionEl = createRegionElement(regionData);
                if (regionData.type === 'omr') {
                    renderOmrRegionContent(regionEl, regionData);
                }
                canvas.appendChild(regionEl);
            });
            updateLayersList();
            updatePropertiesPanel();
            updateHistoryButtons();
            if (selectedRegionId) {
                selectRegion(selectedRegionId, false);
            }
        }

        function createRegionElement(regionData) {
            const el = document.createElement('div');
            el.id = regionData.id;
            el.className = `region ${toolConfig[regionData.type].color}`;
            el.style.left = `${regionData.x}px`;
            el.style.top = `${regionData.y}px`;
            el.style.width = `${regionData.width}px`;
            el.style.height = `${regionData.height}px`;
            el.addEventListener('mousedown', (e) => handleRegionMouseDown(e, regionData.id));
            return el;
        }
        
        function selectRegion(regionId, shouldUpdatePanel = true) {
            if (selectedRegionId === regionId && document.querySelector('.region.selected')) return;
            selectedRegionId = regionId;
            
            document.querySelectorAll('.region').forEach(r => {
                r.classList.remove('selected');
                const oldHandles = r.querySelectorAll('.resize-handle');
                oldHandles.forEach(h => h.remove());
            });

            const selectedEl = document.getElementById(regionId);
            if (selectedEl) {
                selectedEl.classList.add('selected');
                ['nw', 'ne', 'sw', 'se'].forEach(handleType => {
                    const handle = document.createElement('div');
                    handle.className = `resize-handle ${handleType}`;
                    handle.addEventListener('mousedown', (e) => handleRegionMouseDown(e, regionId, handleType));
                    selectedEl.appendChild(handle);
                });
            }
            
            updateLayersList();
            if(shouldUpdatePanel) updatePropertiesPanel();
        }

        // --- Event Handlers ---
        
        function handleCanvasMouseDown(e) {
            if (e.target !== canvas) return;
            if (currentTool) {
                actionState.isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                actionState.startX = (e.clientX - rect.left) / scale;
                actionState.startY = (e.clientY - rect.top) / scale;

                regionCounter = Math.max(0, ...regions.map(r => parseInt(r.id.split('-')[1]) || 0)) + 1;
                const regionId = `region-${regionCounter}`;
                
                actionState.currentRegionEl = document.createElement('div');
                actionState.currentRegionEl.id = regionId;
                actionState.currentRegionEl.className = `region ${toolConfig[currentTool].color}`;
                actionState.currentRegionEl.style.left = `${actionState.startX}px`;
                actionState.currentRegionEl.style.top = `${actionState.startY}px`;
                canvas.appendChild(actionState.currentRegionEl);
            } else {
                selectedRegionId = null;
                renderAll();
            }
        }

        function handleRegionMouseDown(e, regionId, handleType = null) {
            e.stopPropagation();
            selectRegion(regionId);
            const rect = canvas.getBoundingClientRect();
            actionState.startX = (e.clientX - rect.left) / scale;
            actionState.startY = (e.clientY - rect.top) / scale;
            
            if (handleType) {
                actionState.isResizing = true;
                actionState.resizeHandle = handleType;
            } else {
                actionState.isMoving = true;
            }
        }

        function handleDocumentMouseMove(e) {
            if (!actionState.isDrawing && !actionState.isMoving && !actionState.isResizing) return;
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            const mouseX = (e.clientX - rect.left) / scale;
            const mouseY = (e.clientY - rect.top) / scale;
            
            if (actionState.isDrawing) {
                const width = Math.abs(mouseX - actionState.startX);
                const height = Math.abs(mouseY - actionState.startY);
                const newX = Math.min(mouseX, actionState.startX);
                const newY = Math.min(mouseY, actionState.startY);
                actionState.currentRegionEl.style.width = `${width}px`;
                actionState.currentRegionEl.style.height = `${height}px`;
                actionState.currentRegionEl.style.left = `${newX}px`;
                actionState.currentRegionEl.style.top = `${newY}px`;
            } else if (actionState.isMoving) {
                const region = regions.find(r => r.id === selectedRegionId);
                const regionEl = document.getElementById(selectedRegionId);
                const dx = mouseX - actionState.startX;
                const dy = mouseY - actionState.startY;
                regionEl.style.left = `${region.x + dx}px`;
                regionEl.style.top = `${region.y + dy}px`;
            } else if (actionState.isResizing) {
                const region = regions.find(r => r.id === selectedRegionId);
                const regionEl = document.getElementById(selectedRegionId);
                const { x, y, width, height } = region;
                let newX = x, newY = y, newW = width, newH = height;

                if (actionState.resizeHandle.includes('e')) newW = mouseX - x;
                if (actionState.resizeHandle.includes('w')) {
                    newW = x + width - mouseX;
                    newX = mouseX;
                }
                if (actionState.resizeHandle.includes('s')) newH = mouseY - y;
                if (actionState.resizeHandle.includes('n')) {
                    newH = y + height - mouseY;
                    newY = mouseY;
                }
                
                regionEl.style.left = `${newX}px`;
                regionEl.style.top = `${newY}px`;
                regionEl.style.width = `${newW > 0 ? newW : 0}px`;
                regionEl.style.height = `${newH > 0 ? newH : 0}px`;
            }
        }

        function handleDocumentMouseUp(e) {
            let stateChanged = false;
            if (actionState.isDrawing) {
                const el = actionState.currentRegionEl;
                if (el && parseInt(el.style.width) > 20 && parseInt(el.style.height) > 20) {
                    const newRegion = {
                        id: el.id, type: currentTool,
                        x: parseInt(el.style.left), y: parseInt(el.style.top),
                        width: parseInt(el.style.width), height: parseInt(el.style.height),
                        properties: currentTool === 'omr' 
                            ? { startQ: 1, totalQ: 20, options: 4, perRow: 5, points: 2 } 
                            : { questionId: '', fullMarks: '' }
                    };
                    regions.push(newRegion);
                    selectRegion(newRegion.id);
                    stateChanged = true;
                } else if (el) {
                    el.remove();
                }
            } else if (actionState.isMoving) {
                const region = regions.find(r => r.id === selectedRegionId);
                const regionEl = document.getElementById(selectedRegionId);
                region.x = parseInt(regionEl.style.left);
                region.y = parseInt(regionEl.style.top);
                stateChanged = true;
            } else if (actionState.isResizing) {
                const region = regions.find(r => r.id === selectedRegionId);
                const regionEl = document.getElementById(selectedRegionId);
                region.x = parseInt(regionEl.style.left);
                region.y = parseInt(regionEl.style.top);
                region.width = parseInt(regionEl.style.width);
                region.height = parseInt(regionEl.style.height);
                stateChanged = true;
            }
            
            if (stateChanged) {
                saveState();
                renderAll();
            }
            actionState = { isDrawing: false, isMoving: false, isResizing: false, currentRegionEl: null, resizeHandle: null };
        }

        // --- UI Update Functions ---
        
        function updateLayersList() {
            if (regions.length === 0) {
                layersList.innerHTML = `<p class="text-sm text-gray-400 text-center py-4">尚未创建任何区域</p>`;
                return;
            }
            layersList.innerHTML = '';
            regions.forEach(region => {
                const config = toolConfig[region.type];
                const displayName = (region.type === 'subjective' && region.properties.questionId) 
                    ? `${config.name} (${region.properties.questionId})` 
                    : (region.type === 'omr')
                    ? `${config.name} (${region.properties.startQ}-${region.properties.startQ + region.properties.totalQ - 1})`
                    : config.name;
                const layerItem = document.createElement('div');
                layerItem.className = `layer-item flex items-center p-2 rounded-md cursor-pointer hover:bg-gray-100 ${selectedRegionId === region.id ? 'bg-indigo-100' : ''}`;
                layerItem.addEventListener('click', () => selectRegion(region.id));
                layerItem.innerHTML = `<span class="w-4 h-4 rounded-sm ${config.bgColor} mr-3"></span><span class="flex-1 text-sm">${displayName}</span>`;
                layersList.appendChild(layerItem);
            });
        }

        function updatePropertiesPanel() {
            const region = regions.find(r => r.id === selectedRegionId);
            if (!region) {
                propertiesPanel.innerHTML = `<div class="text-center text-gray-400 py-10"><i data-lucide="mouse-pointer-square" class="w-12 h-12 mx-auto"></i><p class="mt-2 text-sm">请先选择一个区域</p></div>`;
                lucide.createIcons();
                return;
            }
            
            let propertiesHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">区域类型</label>
                        <p class="mt-1 text-lg font-semibold ${toolConfig[region.type].color.replace('border', 'text')}">${toolConfig[region.type].name}</p>
                    </div>`;

            if (region.type === 'subjective') {
                propertiesHTML += `
                    <div>
                        <label for="prop-qid" class="block text-sm font-medium text-gray-700">题目编号</label>
                        <input type="text" id="prop-qid" value="${region.properties.questionId || ''}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="prop-marks" class="block text-sm font-medium text-gray-700">满分值</label>
                        <input type="number" id="prop-marks" value="${region.properties.fullMarks || ''}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>`;
            } else if (region.type === 'omr') {
                propertiesHTML += `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="prop-start-q" class="block text-sm font-medium text-gray-700">起始题号</label>
                            <input type="number" id="prop-start-q" value="${region.properties.startQ || 1}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="prop-total-q" class="block text-sm font-medium text-gray-700">题目数量</label>
                            <input type="number" id="prop-total-q" value="${region.properties.totalQ || 20}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="prop-options" class="block text-sm font-medium text-gray-700">选项数量</label>
                            <input type="number" id="prop-options" value="${region.properties.options || 4}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="prop-per-row" class="block text-sm font-medium text-gray-700">每行题数</label>
                            <input type="number" id="prop-per-row" value="${region.properties.perRow || 5}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                         <div class="col-span-2">
                            <label for="prop-points" class="block text-sm font-medium text-gray-700">每题分数</label>
                            <input type="number" id="prop-points" value="${region.properties.points || 2}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                `;
            }
            
            propertiesHTML += `
                <div class="pt-4 border-t">
                    <button id="delete-region-btn" class="w-full text-sm text-red-600 hover:text-red-800 flex items-center justify-center">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>删除此区域
                    </button>
                </div>
            </div>`;

            propertiesPanel.innerHTML = propertiesHTML;
            
            const qidInput = document.getElementById('prop-qid');
            const marksInput = document.getElementById('prop-marks');
            if(qidInput) qidInput.addEventListener('input', (e) => { region.properties.questionId = e.target.value; updateLayersList(); saveState(); });
            if(marksInput) marksInput.addEventListener('input', (e) => { region.properties.fullMarks = e.target.value; saveState(); });
            
            const omrInputs = ['prop-start-q', 'prop-total-q', 'prop-options', 'prop-per-row', 'prop-points'];
            omrInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', (e) => {
                        const propName = id.replace('prop-', '').replace('-q', 'Q');
                        region.properties[propName] = parseInt(e.target.value) || 0;
                        renderAll(); // Re-render to show grid preview
                        saveState();
                    });
                }
            });

            document.getElementById('delete-region-btn').addEventListener('click', () => {
                if (!selectedRegionId) return;
                regions = regions.filter(r => r.id !== selectedRegionId);
                selectedRegionId = null;
                saveState();
                renderAll();
            });
            
            lucide.createIcons();
        }

        // --- Feature Functions ---

        function renderOmrRegionContent(regionEl, regionData) {
            regionEl.innerHTML = ''; // Clear previous content like resize handles
            const { startQ = 1, totalQ = 1, options = 4, perRow = 1 } = regionData.properties;
            if (totalQ <= 0 || perRow <= 0) return;

            const optionChars = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            const container = document.createElement('div');
            container.style.cssText = `
                display: grid;
                grid-template-columns: repeat(${perRow}, 1fr);
                gap: 5px; padding: 10px;
                width: 100%; height: 100%;
                align-content: start;
                overflow: hidden;
            `;

            for (let i = 0; i < totalQ; i++) {
                const questionNumber = startQ + i;
                const item = document.createElement('div');
                item.className = 'omr-grid-item';
                let itemHTML = `<span class="font-bold mr-1">${questionNumber}.</span>`;
                for (let j = 0; j < options; j++) {
                    itemHTML += `<span class="border border-black rounded-sm px-1 mx-0.5">[${optionChars[j]}]</span>`;
                }
                item.innerHTML = itemHTML;
                container.appendChild(item);
            }
            regionEl.appendChild(container);
        }

        function handleTemplateSave() {
            if (regions.length === 0) { alert('模板为空，无法保存！'); return; }
            const templateJSON = JSON.stringify(regions, null, 2);
            const blob = new Blob([templateJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleTemplateLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedRegions = JSON.parse(e.target.result);
                    if (Array.isArray(loadedRegions)) {
                        regions = loadedRegions;
                        saveState();
                        renderAll();
                        alert('模板加载成功！');
                    } else { throw new Error('Invalid template format.'); }
                } catch (error) { alert('加载模板失败，请确保文件格式正确 (JSON)。'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function updateZoom(delta) {
            if (delta === null) { scale = 1; } else { scale += delta; }
            scale = Math.max(0.2, Math.min(scale, 3));
            canvas.style.transform = `scale(${scale})`;
            zoomLevelSpan.textContent = `${Math.round(scale * 100)}%`;
        }
        
        function handleKeyDown(e) {
            if (e.code === 'Space' && !actionState.isPanning) {
                e.preventDefault();
                actionState.isPanning = true;
                canvasWrapper.classList.add('panning');
                canvasWrapper.addEventListener('mousedown', startPan);
            }
        }
        function handleKeyUp(e) {
            if (e.code === 'Space') {
                actionState.isPanning = false;
                canvasWrapper.classList.remove('panning');
                canvasWrapper.removeEventListener('mousedown', startPan);
                canvasWrapper.removeEventListener('mousemove', pan);
                canvasWrapper.removeEventListener('mouseup', endPan);
                canvasWrapper.removeEventListener('mouseleave', endPan);
            }
        }
        function startPan(e) {
            actionState.lastPanX = e.clientX;
            actionState.lastPanY = e.clientY;
            canvasWrapper.addEventListener('mousemove', pan);
            canvasWrapper.addEventListener('mouseup', endPan);
            canvasWrapper.addEventListener('mouseleave', endPan);
        }
        function pan(e) {
            const dx = e.clientX - actionState.lastPanX;
            const dy = e.clientY - actionState.lastPanY;
            canvasWrapper.scrollLeft -= dx;
            canvasWrapper.scrollTop -= dy;
            actionState.lastPanX = e.clientX;
            actionState.lastPanY = e.clientY;
        }
        function endPan() {
            canvasWrapper.removeEventListener('mousemove', pan);
        }

        function saveState() {
            history = history.slice(0, historyIndex + 1);
            history.push(JSON.parse(JSON.stringify(regions)));
            historyIndex++;
            updateHistoryButtons();
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                regions = JSON.parse(JSON.stringify(history[historyIndex]));
                renderAll();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                regions = JSON.parse(JSON.stringify(history[historyIndex]));
                renderAll();
            }
        }

        function updateHistoryButtons() {
            undoBtn.disabled = historyIndex === 0;
            redoBtn.disabled = historyIndex === history.length - 1;
        }

        // --- Init & Helpers ---
        function init() {
            saveState(); // Save initial empty state
            renderAll();
            lucide.createIcons();
        }
        function selectTool(tool) {
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tool-btn[data-tool="${tool}"]`).classList.add('active');
            currentTool = tool;
        }
        function handleBgUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    canvas.style.backgroundImage = `url('${e.target.result}')`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // --- Event Listeners Setup ---
        uploadBgBtn.addEventListener('click', () => bgUploadInput.click());
        bgUploadInput.addEventListener('change', handleBgUpload);
        loadTemplateBtn.addEventListener('click', () => loadTemplateInput.click());
        loadTemplateInput.addEventListener('change', handleTemplateLoad);
        saveBtn.addEventListener('click', handleTemplateSave);
        
        document.querySelectorAll('.tool-btn').forEach(btn => btn.addEventListener('click', () => selectTool(btn.dataset.tool)));
        
        canvas.addEventListener('mousedown', handleCanvasMouseDown);
        document.addEventListener('mousemove', handleDocumentMouseMove);
        document.addEventListener('mouseup', handleDocumentMouseUp);

        zoomInBtn.addEventListener('click', () => updateZoom(0.1));
        zoomOutBtn.addEventListener('click', () => updateZoom(-0.1));
        resetZoomBtn.addEventListener('click', () => updateZoom(null));

        undoBtn.addEventListener('click', undo);
        redoBtn.addEventListener('click', redo);
        
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        
        init();

    </script>

</body>

</html>
